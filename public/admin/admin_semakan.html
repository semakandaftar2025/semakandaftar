<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Semakan Daftar Peguam Syarie Negeri Perlis</title>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined&icon_names=search" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script>
  document.documentElement.classList.add("preload");
</script>
</head>
<body>

<!-- Overlay background -->
<div id="modalOverlay" class="modal-overlay" style="display: none;"></div>

<!-- Modal itself -->
<div id="butiranModal" style="display: none;">
  <div class="modal-scroll-wrapper">
    <button class="closeModal" id="closeModalBtn">Ã—</button>
    <div class="modal-content" id="profileContainer">
      <div id="profileImageContainer"></div>
      <h2 id="profileName"></h2>
      <table id="profileTable"></table>
      <!-- REMOVE and EDIT buttons -->
      <div class="edit-remove-btn">
        <div class="remove-peguam-btn">
          <button id="modalRemoveBtn" class="btn-danger-custom remove-btn">Padam</button>
        </div>
        <div class="edit-peguam-btn">
          <button id="modalEditBtn" class="edit-btn" data-doc-id="">Edit</button>
        </div>
    </div>
  </div>
</div>
</div>

<!-- Overlay for removeModal -->
<div id="modalOverlayRemove" class="modal-overlay" style="display:none;"></div>

<!-- Remove Confirmation Modal -->
<div id="removeModal" class="modal" style="display:none;">
  <div class="modal-scroll-wrapper">
    <div class="modal-content-remove">
      <button id="closeRemoveModalBtn" class="closeRemoveModal">&times;</button>
      <h2>Padam Peguam</h2>
      <p>Anda pasti mahu memadam maklumat peguam berikut?</p>
      <div class="remove-info-box">
        <strong>Nama:</strong> <span id="removeNamaDisplay"></span><br>
        <strong>ID Dokumen:</strong> <span id="removeDocIdDisplay"></span>
      </div>
      <div class="confirm-delete">
        <button id="confirmDeleteBtn">Ya, Padam</button>
        <button id="cancelDeleteBtn">Batal</button>
      </div>
    </div>
  </div>
</div>

  <!-- Navigation -->
  <div class="nav">
    <div class="nav-left">
      <div class="nav-logo">
        <img src="/images/jata perlis.png" alt="Jata Perlis" class="logo-img" />
      </div>
    </div>
    <div class="nav-right">
      <img src="/images/logo sistem.png" alt="Logo Sistem" class="logo-img" />
    </div>
  </div>

  <!-- Sidebar -->
  <div class="page-wrapper">
    <div id="sidebar" class="sidebar">
      <ul>
        <li>
          <span class="logo full-logo">Sistem Semakan Daftar Peguam Syarie</span>
          <span class="logo short-logo">SSPS</span>
          <button id="toggleBtn">
            <i id="toggleIcon" class="bx bx-chevrons-left" style="font-size: 24px;"></i>
          </button>
        </li>
        <div class="menu-links">
          <li><a href="/admin/admin_homepage.html"><i class="bx bxs-home"></i><span> Home</span></a></li>
          <li class="active"><a href="#"><i class="bx bxs-user-check"></i><span> Semakan Daftar</span></a></li>
          <li><a href="/admin/admin_faq.html"><i class="bx bxs-help-circle"></i><span> FAQ</span></a></li>
          <li><a href="/admin/admin_about.html"><i class="bx bxs-info-circle"></i><span> About</span></a></li>
          <li class="logout"><a href="#" id="logoutBtn"><i class="bx bx-power-off"></i><span> Logout</span></a></li>
        </div>
      </ul>
    </div>

    <!-- Main Content -->
    <div id="content">
      <main>
        <h1>Semakan Daftar Peguam Syarie</h1>
      </main>

      <div class="container">
        <div class="semakan-container">
          <form class="search-row" action="#" method="get" onsubmit="return false;">
            <div class="search-filter">
              <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" name="search" placeholder="Search..." />
              </div>
              <select id="filterOption">
                <option value="all">All</option>
                <option value="nama">Nama</option>
                <option value="kelulusan">Kelulusan</option>
                <option value="namaFirma">Nama Firma</option>
                <option value="noTel">No Telefon</option>
                <option value="status">Status</option>
              </select>
            </div>
            <a href="add_form.html">
              <button type="button" class="add-btn">+ ADD</button>
            </a>  
          </form>
          
          <div class="content-row">
            <div class="entry-limit-row">
              <label for="entryLimitSelect">Show</label>
              <select id="entryLimitSelect">
                <option value="5" selected>5</option>
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="30">30</option>
              </select>
              <span>entries:</span>
            </div>
            
            <table>
              <thead>
                <tr>
                  <th>No.</th>
                  <th>Nama</th>
                  <th>Kelulusan Akademik</th>
                  <th>Nama Firma</th>
                  <th>No Telefon</th>
                  <th>Status</th>
                  <th>Butiran</th>
                </tr>
              </thead>
              <tbody id="peguamTableBody">
                <!-- Table data will appear here -->
              </tbody>
            </table>
            <div class="count-prevnext">
              <h4 id="entrySummary">Loading entry count...</h4>
            <div class="pagination-buttons" style="margin-top: 10px;">
              <button id="prevPageBtn">Previous</button>
              <button id="nextPageBtn">Next</button>
            </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Firebase & JS -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBGo7VyWereRHO4UBXn8VH2z56HUzGoAkM",
    authDomain: "semakan-daftar-c9267.firebaseapp.com",
    projectId: "semakan-daftar-c9267",
    storageBucket: "semakan-daftar-c9267.appspot.com",
    messagingSenderId: "1090274861346",
    appId: "1:1090274861346:web:a54aef11652f8dcd82057b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const tableBody = document.getElementById("peguamTableBody");
  const entrySummary = document.getElementById("entrySummary");
  const entryLimitSelect = document.getElementById("entryLimitSelect");
  const searchInput = document.getElementById("searchInput");
  const prevPageBtn = document.getElementById("prevPageBtn");
  const nextPageBtn = document.getElementById("nextPageBtn");
  const filterOption = document.getElementById("filterOption");

  let currentPage = 1;
  let totalPages = 1;
  let allData = []; // Store all fetched data once

  async function fetchDataOnce() {
    const baseQuery = query(collection(db, "peguamsyarie"), orderBy("nama"));
    const snapshot = await getDocs(baseQuery);

    allData = snapshot.docs.map((doc) => ({
      docId: doc.id,
      ...doc.data()
    }));
  }

  function filterAndPaginateData(searchTerm = "") {
    const entryLimit = parseInt(entryLimitSelect.value);
    const selectedFilter = filterOption.value;
    const lowerSearch = searchTerm.trim().toLowerCase();

    // Filter based on search
    let filteredData = allData.filter((data) => {
      if (searchTerm.trim() === "") return true;

      if (selectedFilter === "all") {
        return (
          (data.nama && data.nama.toLowerCase().includes(lowerSearch)) ||
          (data.kelulusan && data.kelulusan.toLowerCase().includes(lowerSearch)) ||
          (data.namaFirma && data.namaFirma.toLowerCase().includes(lowerSearch)) ||
          (data.noTel && data.noTel.toLowerCase().includes(lowerSearch)) ||
          (data.status && data.status.toLowerCase().includes(lowerSearch))
        );
      } else {
        return (
          data[selectedFilter] &&
          data[selectedFilter].toLowerCase().includes(lowerSearch)
        );
      }
    });

    const totalEntries = filteredData.length;
    totalPages = Math.ceil(totalEntries / entryLimit);
    const startIndex = (currentPage - 1) * entryLimit;
    const paginatedData = filteredData.slice(startIndex, startIndex + entryLimit);

    // Clear table and insert new rows
    tableBody.innerHTML = "";
    paginatedData.forEach((data, index) => {
      addRow(startIndex + index + 1, data, data.docId);
    });

    entrySummary.textContent = `Showing ${startIndex + 1} to ${startIndex + paginatedData.length} of ${totalEntries} entries`;
    prevPageBtn.style.display = currentPage > 1 ? "inline-block" : "none";
    nextPageBtn.style.display = currentPage < totalPages ? "inline-block" : "none";
  }

  function addRow(no, data, docId) {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${no}</td>
      <td>${data.nama || '-'}</td>
      <td>${data.kelulusan || '-'}</td>
      <td>${data.namaFirma || '-'}</td>
      <td>${data.noTel || '-'}</td>
      <td>${data.status || '-'}</td>
      <td><button class="butiran-btn" data-doc-id="${docId}">Lihat Butiran</button></td>
    `;
    tableBody.appendChild(row);
  }

  document.addEventListener("DOMContentLoaded", async () => {
    await fetchDataOnce(); // Fetch data once on page load
    filterAndPaginateData();

    document.querySelector(".closeModal").addEventListener("click", function () {
      document.getElementById("butiranModal").style.display = "none";
    });

    entryLimitSelect.addEventListener("change", () => {
      currentPage = 1;
      filterAndPaginateData(searchInput.value.trim());
    });

    searchInput.addEventListener("input", () => {
      currentPage = 1;
      filterAndPaginateData(searchInput.value.trim());
    });

    filterOption.addEventListener("change", () => {
      currentPage = 1;
      filterAndPaginateData(searchInput.value.trim());
    });

    prevPageBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        filterAndPaginateData(searchInput.value.trim());
      }
    });

    nextPageBtn.addEventListener("click", () => {
      if (currentPage < totalPages) {
        currentPage++;
        filterAndPaginateData(searchInput.value.trim());
      }
    });
  });

  onAuthStateChanged(auth, (user) => {
    if (user && user.email === "semakandaftarpeguamsyarie2025@gmail.com") {
      console.log("Admin authenticated");
    } else {
      alert("Please log in to access the admin page.");
      window.location.replace("login.html");
    }
  });

  document.getElementById("logoutBtn").addEventListener("click", () => {
    signOut(auth).then(() => {
      alert("You have been logged out.");
      window.location.replace("login.html");
    }).catch((error) => {
      console.error("Logout error:", error);
    });
  });
</script>


<script type="module" src="/app.js"></script>
<script type="module" src="modal.js"></script>
<script>
    window.addEventListener("load", function () {
      document.body.classList.add("loaded");
    });

  window.addEventListener("load", () => {
    document.documentElement.classList.remove("preload");
  });
  </script>

</body>
</html>