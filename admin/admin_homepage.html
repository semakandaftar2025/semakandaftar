<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Semakan Daftar Peguam Syarie Negeri Perlis</title>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/style.css" />
  <script src="/app.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
<script>
  document.documentElement.classList.add("preload");
</script>
</head>
<body>
  <div class="nav">
    <div class="nav-left">
      <div class="nav-logo">
        <img src="/images/jata negara.png" alt="Jata Negara" class="logo-img" />
        <img src="/images/jata perlis.png" alt="Jata Perlis" class="logo-img" />
        <img src="/images/jksnps logo.png" alt="Logo JKSNPs" class="logo-img" />
      </div>
    </div>
    <div class="nav-right">
      <img src="/images/logo sistem.png" alt="Logo Sistem" class="logo-img" />
    </div>
  </div>

  <div class="page-wrapper">
    <div id="sidebar" class="sidebar">
      <ul>
        <li>
          <span class="logo full-logo">Sistem Semakan Daftar Peguam Syarie</span>
          <span class="logo short-logo">SSPS</span>
          <button id="toggleBtn">
            <i id="toggleIcon" class="bx bx-chevrons-left" style="font-size: 24px;"></i>
          </button>
        </li>
        <div class="menu-links">
          <li class="active">
            <a href="#"><i class="bx bxs-home"></i><span> Home</span></a>
          </li>
          <li>
            <a href="/admin/admin_semakan.html"><i class="bx bxs-user-check"></i><span> Semakan Daftar</span></a>
          </li>
          <li>
            <a href="/admin/admin_faq.html"><i class="bx bxs-help-circle"></i><span> FAQ</span></a>
          </li>
          <li>
            <a href="/admin/admin_about.html"><i class="bx bxs-info-circle"></i><span> About</span></a>
          </li>
          <li class="logout">
            <a href="#" id="logoutBtn"><i class="bx bx-power-off"></i><span> Logout</span></a>
          </li>
        </div>
      </ul>
    </div>

    <div id="content">
      <main>
        <h1>Admin Panel</h1>
      </main>

      <div class="container">
        <div class="left-section">
          <div class="card-row">
            <div class="card">
              <div class="container">
                <h4 class="label">Numbers of Registered Peguam Syarie</h4>
                <h4 class="count">0</h4>
              </div>
            </div>
            <div class="card">
              <div class="container">
                <h4 class="label">Number of Candidates Who Passed</h4>
                <h4 class="count">0</h4>
              </div>
            </div>
            <div class="card">
              <div class="container">
                <h4 class="label">Number of Candidates Who Failed</h4>
                <h4 class="count">0</h4>
              </div>
            </div>
          </div>
          <div style="width: 100%; max-width: 1000px; margin-top: 20px;">
            <canvas id="myChart"></canvas>
          </div>
        </div>

        <div class="right-section">
          <div class="clock-box">
            <div id="showDate"></div>
            <div class="showTime">
              <span id="hrs"></span>
              <span>:</span>
              <span id="min"></span>
              <span>:</span>
              <span id="sec"></span>
            </div>
          </div>
          <div class="senarai">
            <h1>Senarai Terkini</h1>
            <div class="list">
              <table>
                <thead>
                  <tr>
                    <th>Nama</th>
                    <th>No Resit</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="latestTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";

  // âœ… Redirect to login if not logged in or not admin
  onAuthStateChanged(auth, (user) => {
    if (!user || user.email !== "semakandaftarpeguamsyarie2025@gmail.com") {
      alert("Admin access only. Please log in first.");
      window.location.replace("login.html");
    }
  });

  const firebaseConfig = {
      apiKey: "AIzaSyBGo7VyWereRHO4UBXn8VH2z56HUzGoAkM",
      authDomain: "semakan-daftar-c9267.firebaseapp.com",
      projectId: "semakan-daftar-c9267",
      storageBucket: "semakan-daftar-c9267.appspot.com",
      messagingSenderId: "1090274861346",
      appId: "1:1090274861346:web:a54aef11652f8dcd82057b"
    };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  async function loadDashboardData() {
  const peguamsRef = collection(db, "peguamsyarie");
  const snapshot = await getDocs(peguamsRef);

  let total = 0, passed = 0, failed = 0, pending = 0, aktif = 0, tidakaktif = 0;
  const allPeguam = [];

  snapshot.forEach((doc) => {
    const data = doc.data();
    total++;
    if (data.status === "lulus") passed++;
    else if (data.status === "gagal") failed++;
    else if (data.status === "menunggu") pending++;
    else if (data.status === "aktif") aktif++;
    else if (data.status === "tidak aktif") tidakaktif++;

    let resitValue = data.noResit === "0" ? "TIADA" : data.noResit || "-";

    allPeguam.push({
      nama: data.nama || "-",
      noResit: resitValue,
      status: data.status || "-",
      createdAt: data.createdAt?.toDate?.() || new Date(0) // Default to epoch if missing
    });
  });

  document.querySelectorAll(".count")[0].textContent = total;
  document.querySelectorAll(".count")[1].textContent = passed;
  document.querySelectorAll(".count")[2].textContent = failed;

  const ctx = document.getElementById("myChart").getContext("2d");
  new Chart(ctx, {
    type: "pie",
    data: {
      labels: ["Lulus", "Gagal", "Menunggu", "Aktif", "Tidak Aktif"],
      datasets: [{
        label: "Status Calon",
        data: [passed, failed, pending, aktif, tidakaktif],
        backgroundColor: ["#4CAF50", "#f44336", "#FFC107", "#03A9F4", "#9C27B0"]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      legend: {
        position: "bottom"
      }
    }
  });

  // ðŸ”½ Sort and show 5 latest entries
  allPeguam.sort((a, b) => b.createdAt - a.createdAt);
  const latestFive = allPeguam.slice(0, 5);

  const tableBody = document.getElementById("latestTableBody");
  tableBody.innerHTML = "";

  latestFive.forEach((item) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${item.nama}</td>
      <td>${item.noResit}</td>
      <td>${item.status}</td>
    `;
    tableBody.appendChild(row);
  });
}

document.getElementById("logoutBtn").addEventListener("click", (e) => {
    e.preventDefault();
    signOut(auth).then(() => {
      // Redirect to login page after successful logout
      alert("You have been logged out.");
      window.location.replace("login.html");
    }).catch((error) => {
      console.error("Logout error:", error);
    });
  });


  loadDashboardData();
</script>

<script>
    window.addEventListener("load", function () {
      document.body.classList.add("loaded");
    });

  window.addEventListener("load", () => {
    document.documentElement.classList.remove("preload");
  });
  </script>

</body>
</html>
